/*
 * Copyright (c) 2022, Stefano Cottafavi
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include "tmc.h"
#include "tmc2209.h"

struct reg regs[] = {
	{"GCONF",		{ TMC2209_GCONF, 		"rw"	}},
	{"GSTAT",		{ TMC2209_GSTAT, 		"rwc"   }},
	{"IFCNT",		{ TMC2209_IFCNT, 		"r"		}},
	{"SLAVECONF",	{ TMC2209_SLAVECONF, 	"w"		}},
	{"OTP_PROG",	{ TMC2209_OTP_PROG, 	"w"		}},
	{"OTP_READ",	{ TMC2209_OTP_READ, 	"r"		}},
	{"IOIN",		{ TMC2209_IOIN, 		"r"		}},
	{"FACTORY_CONF",{ TMC2209_FACTORY_CONF, "rw"	}},

    {"IHOLD_IRUN",	{ TMC2209_IHOLD_IRUN, 	"w"		}},
	{"TPOWERDOWN",	{ TMC2209_TPOWERDOWN, 	"w"		}},
	{"TSTEP",		{ TMC2209_TSTEP, 		"r"		}},
	{"TPWMTHRS",	{ TMC2209_TPWMTHRS, 	"w"		}},
	{"TCOOLTHRS",	{ TMC2209_TCOOLTHRS,	"w"		}},

	{"VACTUAL",		{ TMC2209_VACTUAL, 		"w"		}},

	{"SGTHRS",		{ TMC2209_SGTHRS, 		"w"		}},
	{"SG_RESULT",	{ TMC2209_SG_RESULT, 	"r"		}},
	{"COOLCONF",	{ TMC2209_COOLCONF, 	"w"		}},

	{"MSCNT",		{ TMC2209_MSCNT, 		"r"		}},
	{"MSCURACT",	{ TMC2209_MSCURACT, 	"r"		}},

	{"CHOPCONF",	{ TMC2209_CHOPCONF, 	"rw"	}},
	{"DRVSTATUS",	{ TMC2209_DRVSTATUS, 	"r"		}},
	{"PWMCONF",		{ TMC2209_PWMCONF,		"rw"	}},
	{"PWMSCALE",	{ TMC2209_PWMSCALE,		"r"		}},
	{"PWM_AUTO",	{ TMC2209_PWM_AUTO,		"r"		}},

};

// map fields
struct field fields[] = {
	// 0x00 GCONF
	{ "iscaleanalog",{TMC2209_GCONF, 		TMC2209_SHAFT_MASK, 	TMC2209_SHAFT_SHIFT}},
	{ "shaft", 		{TMC2209_GCONF, 		TMC2209_SHAFT_MASK, 	TMC2209_SHAFT_SHIFT}},
	// TODO: complete above

	// 0x01 GSTAT
	{ "reset", 		{TMC2209_GSTAT, 		TMC2209_RESET_MASK, 	TMC2209_RESET_SHIFT}},
	{ "drverr", 	{TMC2209_GSTAT, 		TMC2209_DRV_ERR_MASK, 	TMC2209_DRV_ERR_SHIFT}},
	{ "uvcp", 		{TMC2209_GSTAT, 		TMC2209_UV_CP_MASK, 	TMC2209_UV_CP_SHIFT}},

	// 0x02 IFNCT
	{ "ifcnt", 		{TMC2209_IFCNT, 		TMC2209_IFCNT_MASK, 	TMC2209_IFCNT_SHIFT}},

	// 0x03 SLAVECONF
	{ "senddelay", 	{TMC2209_SLAVECONF, 	TMC2209_SLAVECONF_MASK, TMC2209_SLAVECONF_SHIFT}},

	// 0x06 IOIN
	{ "enn", 		{TMC2209_IOIN, 			TMC2209_ENN_MASK, 		TMC2209_ENN_SHIFT}},
	{ "ms1", 		{TMC2209_IOIN, 			TMC2209_MS1_MASK, 		TMC2209_MS1_SHIFT}},
	{ "ms2", 		{TMC2209_IOIN, 			TMC2209_MS2_MASK, 		TMC2209_MS2_SHIFT}},
	{ "diag", 		{TMC2209_IOIN, 			TMC2209_DIAG_MASK, 		TMC2209_DIAG_SHIFT}},
	{ "pdn_uart", 	{TMC2209_IOIN, 			TMC2209_PDN_UART_MASK, 	TMC2209_PDN_UART_SHIFT}},
	{ "step", 		{TMC2209_IOIN, 			TMC2209_STEP_MASK, 		TMC2209_STEP_SHIFT}},
	// TODO: missing SPREAD_EN
	{ "dir", 		{TMC2209_IOIN, 			TMC2209_DIR_MASK, 		TMC2209_DIR_SHIFT}},
	{ "version", 	{TMC2209_IOIN, 			TMC2209_VERSION_MASK, 	TMC2209_VERSION_SHIFT}},

	// 0x10 IHOLD_IRUN
	{ "ihold", 		{TMC2209_IHOLD_IRUN, 	TMC2209_IHOLD_MASK, 		TMC2209_IHOLD_SHIFT}},
    { "irun",  		{TMC2209_IHOLD_IRUN, 	TMC2209_IRUN_MASK, 			TMC2209_IRUN_SHIFT}},
	{ "iholddelay", {TMC2209_IHOLD_IRUN, 	TMC2209_IHOLDDELAY_MASK, 	TMC2209_IHOLDDELAY_SHIFT}},

	// 0x12 TSTEP
	{ "tstep", 		{TMC2209_TSTEP, 		TMC2209_TSTEP_MASK, 	TMC2209_TSTEP_SHIFT}},

	// 0x22 SPEED
	{ "vactual", 	{TMC2209_VACTUAL, 		TMC2209_VACTUAL_MASK, 	TMC2209_VACTUAL_SHIFT}},

	// 0x6F DRVSTATUS
	{ "stst",		{TMC2209_DRVSTATUS, 	TMC2209_STST_MASK, 			TMC2209_STST_SHIFT}},
	{ "stealth",	{TMC2209_DRVSTATUS, 	TMC2209_STEALTH_MASK, 		TMC2209_STEALTH_SHIFT}},
	{ "csactual",	{TMC2209_DRVSTATUS, 	TMC2209_CS_ACTUAL_MASK, 	TMC2209_CS_ACTUAL_SHIFT}},

	{ "t157",		{TMC2209_DRVSTATUS, 	TMC2209_T157_MASK, 			TMC2209_T157_SHIFT}},
	{ "t150",		{TMC2209_DRVSTATUS, 	TMC2209_T150_MASK, 			TMC2209_T150_SHIFT}},
	{ "t143",		{TMC2209_DRVSTATUS, 	TMC2209_T143_MASK, 			TMC2209_T143_SHIFT}},
	{ "t120",		{TMC2209_DRVSTATUS, 	TMC2209_T120_MASK, 			TMC2209_T120_SHIFT}},

	{ "olb",		{TMC2209_DRVSTATUS, 	TMC2209_OLB_MASK, 			TMC2209_OLB_SHIFT}},
	{ "ola",		{TMC2209_DRVSTATUS, 	TMC2209_OLA_MASK, 			TMC2209_OLA_SHIFT}},
	{ "s2vsb",		{TMC2209_DRVSTATUS, 	TMC2209_S2VSB_MASK, 		TMC2209_S2VSB_SHIFT}},
	{ "s2vsa",		{TMC2209_DRVSTATUS, 	TMC2209_S2VSA_MASK, 		TMC2209_S2VSA_SHIFT}},
	{ "s2gb",		{TMC2209_DRVSTATUS, 	TMC2209_S2GB_MASK, 			TMC2209_S2GB_SHIFT}},
	{ "s2ga",		{TMC2209_DRVSTATUS, 	TMC2209_S2GA_MASK, 			TMC2209_S2GA_SHIFT}},
	{ "ot",			{TMC2209_DRVSTATUS, 	TMC2209_OT_MASK, 			TMC2209_OT_SHIFT}},
	{ "otpw",		{TMC2209_DRVSTATUS, 	TMC2209_OTPW_MASK, 			TMC2209_OTPW_SHIFT}},


};
