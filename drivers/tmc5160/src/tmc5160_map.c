/*
 * Copyright (c) 2022, Stefano Cottafavi
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include "tmc.h"
#include "tmc5160.h"

struct reg regs[] = {
	{"GCONF",		{ TMC5160_GCONF, 		"rw"	}},
	{"GSTAT",		{ TMC5160_GSTAT, 		"rwc"   }},
	{"IFCNT",		{ TMC5160_IFCNT, 		"r"		}},
	{"INP_OUT",		{ TMC5160_INP_OUT, 		"r"		}},
	{"SLAVECONF",	{ TMC5160_SLAVECONF, 	"w"		}},
    {"IHOLD_IRUN",	{ TMC5160_IHOLD_IRUN, 	"w"		}},
	// ramp
	{"RAMPMODE",	{ TMC5160_RAMPMODE, 	"rw"	}},
	{"XACTUAL",		{ TMC5160_XACTUAL, 		"rw"	}},
	{"VACTUAL",		{ TMC5160_VACTUAL, 		"r"		}},
	{"VSTART",		{ TMC5160_VSTART, 		"w"		}},
	{"A1",			{ TMC5160_A1, 			"w"		}},
	{"V1",			{ TMC5160_V1, 			"w"		}},
	{"AMAX",		{ TMC5160_AMAX, 		"w"		}},
	{"VMAX",		{ TMC5160_VMAX, 		"w"		}},
	{"DMAX",		{ TMC5160_DMAX, 		"w"		}},
	{"D1",			{ TMC5160_D1, 			"w"		}},
	{"VSTOP",		{ TMC5160_VSTOP, 		"w"		}},
	{"TZEROWAIT",	{ TMC5160_TZEROWAIT, 	"w"		}},
	{"XTARGET",		{ TMC5160_XTARGET,		"rw"	}},
	{"SW_MODE",		{ TMC5160_SWMODE,		"rw"	}},
	{"RAMP_STAT",	{ TMC5160_RAMPSTAT,		"rw"	}},
	{"XLATCH",		{ TMC5160_XLATCH,		"r"		}},
	// encoder
	{"ENCMODE",		{ TMC5160_ENCMODE,		"rw"	}},
	{"X_ENC",		{ TMC5160_XENC,			"rw"	}},
	{"ENC_CONST",	{ TMC5160_ENC_CONST,	"w"		}},
	{"ENC_STATUS",	{ TMC5160_ENC_STATUS,	"rwc"	}},
	{"ENC_LATCH",	{ TMC5160_ENC_LATCH,	"r"		}},
	{"ENC_DEVIATION",{ TMC5160_ENC_DEVIATION,"w"	}},
};

// map fields
struct field fields[] = {
	// 0x00 GCONF
	{ "iscaleanalog",{TMC5160_GCONF, 		TMC5160_SHAFT_MASK, 	TMC5160_SHAFT_SHIFT}},
	{ "shaft", 		{TMC5160_GCONF, 		TMC5160_SHAFT_MASK, 	TMC5160_SHAFT_SHIFT}},
	// TODO: complete above
	// 0x01 GSTAT
	{ "reset", 		{TMC5160_GSTAT, 		TMC5160_RESET_MASK, 	TMC5160_RESET_SHIFT}},
	{ "drverr", 	{TMC5160_GSTAT, 		TMC5160_DRV_ERR_MASK, 	TMC5160_DRV_ERR_SHIFT}},
	{ "uvcp", 		{TMC5160_GSTAT, 		TMC5160_UV_CP_MASK, 	TMC5160_UV_CP_SHIFT}},
	// 0x02 IFNCT
	{ "ifcnt", 		{TMC5160_IFCNT, 		TMC5160_IFCNT_MASK, 	TMC5160_IFCNT_SHIFT}},
	// 0x03 SLAVECONF
	{ "slaveaddr", 	{TMC5160_SLAVECONF, 	TMC5160_SLAVEADDR_MASK, TMC5160_SLAVEADDR_SHIFT}},
	{ "senddelay", 	{TMC5160_SLAVECONF, 	TMC5160_SENDDELAY_MASK, TMC5160_SENDDELAY_SHIFT}},
	// 0x04 IOIN
	{ "reflstep", 	{TMC5160_INP_OUT, 		TMC5160_REFL_STEP_MASK, 		TMC5160_REFL_STEP_SHIFT}},
	{ "refrdir", 	{TMC5160_INP_OUT, 		TMC5160_REFR_DIR_MASK, 			TMC5160_REFR_DIR_SHIFT}},
	{ "encbdcen", 	{TMC5160_INP_OUT, 		TMC5160_ENCB_DCEN_CFG4_MASK, 	TMC5160_ENCB_DCEN_CFG4_SHIFT}},
	{ "encadcin", 	{TMC5160_INP_OUT, 		TMC5160_ENCA_DCIN_CFG5_MASK, 	TMC5160_ENCA_DCIN_CFG5_SHIFT}},
	//...
	{ "version", 	{TMC5160_INP_OUT, 		TMC5160_VERSION_MASK, 				TMC5160_VERSION_SHIFT}},
	{ "uart", 		{TMC5160_INP_OUT, 		TMC5160_OUTPUT_PIN_POLARITY_MASK, 	TMC5160_OUTPUT_PIN_POLARITY_SHIFT}},

	// 0x10 IHOLD_IRUN
	{ "ihold", 		{TMC5160_IHOLD_IRUN, 	TMC5160_IHOLD_MASK, 		TMC5160_IHOLD_SHIFT}},
    { "irun",  		{TMC5160_IHOLD_IRUN, 	TMC5160_IRUN_MASK, 			TMC5160_IRUN_SHIFT}},
	{ "iholddelay", {TMC5160_IHOLD_IRUN, 	TMC5160_IHOLDDELAY_MASK, 	TMC5160_IHOLDDELAY_SHIFT}},
	// 0x12 TSTEP
	{ "tstep", 		{TMC5160_TSTEP, 		TMC5160_TSTEP_MASK, 	TMC5160_TSTEP_SHIFT}},
	// 0x20 RAMPMODE
	{ "rampmode", 	{TMC5160_RAMPMODE, 		TMC5160_RAMPMODE_MASK, 	TMC5160_RAMPMODE_SHIFT}},
	{ "xactual", 	{TMC5160_XACTUAL, 		TMC5160_XACTUAL_MASK, 	TMC5160_XACTUAL_SHIFT}},
	{ "vactual", 	{TMC5160_VACTUAL, 		TMC5160_VACTUAL_MASK, 	TMC5160_VACTUAL_SHIFT}},
	{ "vstart", 	{TMC5160_VSTART, 		TMC5160_VSTART_MASK, 	TMC5160_VSTART_SHIFT}},
	{ "a1", 		{TMC5160_A1, 			TMC5160_A1_MASK, 		TMC5160_A1_SHIFT}},
	{ "v1", 		{TMC5160_V1, 			TMC5160_V1__MASK, 		TMC5160_V1__SHIFT}},
	{ "amax", 		{TMC5160_AMAX, 			TMC5160_AMAX_MASK, 		TMC5160_AMAX_SHIFT}},
	{ "vmax", 		{TMC5160_VMAX, 			TMC5160_VMAX_MASK, 		TMC5160_VMAX_SHIFT}},
	{ "dmax", 		{TMC5160_DMAX, 			TMC5160_DMAX_MASK, 		TMC5160_DMAX_SHIFT}},
	{ "d1", 		{TMC5160_D1, 			TMC5160_D1_MASK, 		TMC5160_D1_SHIFT}},
	{ "vstop", 		{TMC5160_VSTOP, 		TMC5160_VSTOP_MASK, 	TMC5160_VSTOP_SHIFT}},
	{ "tzerowait", 	{TMC5160_TZEROWAIT, 	TMC5160_TZEROWAIT_MASK, TMC5160_TZEROWAIT_SHIFT}},
	{ "xtarget", 	{TMC5160_XTARGET, 		TMC5160_XTARGET_MASK, 	TMC5160_XTARGET_SHIFT}},
	// switch mode config
	{ "en_softstop",{TMC5160_SWMODE, 	TMC5160_EN_SOFTSTOP_MASK, 	TMC5160_EN_SOFTSTOP_SHIFT}},
	{ "sg_stop",	{TMC5160_SWMODE, 	TMC5160_SG_STOP_MASK, 		TMC5160_SG_STOP_SHIFT}},
	// TODO: complete above

	// 0x35 RAMP_STAT
	{ "statussg",	{TMC5160_RAMPSTAT, 		TMC5160_STATUS_SG_MASK, 	TMC5160_STATUS_SG_SHIFT}},

	// driver status
	{ "stst",		{TMC5160_DRVSTATUS, 	TMC5160_STST_MASK, 			TMC5160_STST_SHIFT}},
	{ "olb",		{TMC5160_DRVSTATUS, 	TMC5160_OLB_MASK, 			TMC5160_OLB_SHIFT}},
	{ "ola",		{TMC5160_DRVSTATUS, 	TMC5160_OLA_MASK, 			TMC5160_OLA_SHIFT}},
	{ "s2gb",		{TMC5160_DRVSTATUS, 	TMC5160_S2GB_MASK, 			TMC5160_S2GB_SHIFT}},
	{ "s2ga",		{TMC5160_DRVSTATUS, 	TMC5160_S2GA_MASK, 			TMC5160_S2GA_SHIFT}},
	{ "otpw",		{TMC5160_DRVSTATUS, 	TMC5160_OTPW_MASK, 			TMC5160_OTPW_SHIFT}},
	{ "ot",			{TMC5160_DRVSTATUS, 	TMC5160_OT_MASK, 			TMC5160_OT_SHIFT}},
	{ "stallguard",	{TMC5160_DRVSTATUS, 	TMC5160_STALLGUARD_MASK, 	TMC5160_STALLGUARD_SHIFT}},
	{ "csactual",	{TMC5160_DRVSTATUS, 	TMC5160_CS_ACTUAL_MASK, 	TMC5160_CS_ACTUAL_SHIFT}},
	{ "fsactive",	{TMC5160_DRVSTATUS, 	TMC5160_FSACTIVE_MASK, 		TMC5160_FSACTIVE_SHIFT}},
	{ "stealth",	{TMC5160_DRVSTATUS, 	TMC5160_STEALTH_MASK, 		TMC5160_STEALTH_SHIFT}},
	{ "s2vsb",		{TMC5160_DRVSTATUS, 	TMC5160_S2VSB_MASK, 		TMC5160_S2VSB_SHIFT}},
	{ "s2vsa",		{TMC5160_DRVSTATUS, 	TMC5160_S2VSA_MASK, 		TMC5160_S2VSA_SHIFT}},
	{ "sgresult",	{TMC5160_DRVSTATUS, 	TMC5160_SG_RESULT_MASK, 	TMC5160_SG_RESULT_SHIFT}},
};
